<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard Supervisor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">Panel de Supervisor</a>
      <button class="btn btn-outline-light" id="btnLogout">Cerrar sesión</button>
    </div>
  </nav>

  <div class="container py-5">
    <h2 id="saludo" class="text-center mb-4"></h2>

    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">📋 Lista de usuarios (solo lectura)</h5>
        <p class="text-muted">El supervisor puede visualizar los usuarios registrados y su estado actual.</p>
        <hr>
        <div id="lista" class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-primary text-center">
              <tr>
                <th>Nombre</th>
                <th>Correo</th>
                <th>Rol</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="tbodyUsuarios"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  // 🚫 Deshabilitar caché para evitar volver atrás
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.getRegistrations().then(function (registrations) {
      for (let registration of registrations) {
        registration.unregister();
      }
    });
  }

  window.addEventListener('pageshow', function (event) {
    if (event.persisted) {
      window.location.reload();
    }
  });

  // Verificar sesión al cargar
  function verificarSesion() {
    const usuario = JSON.parse(localStorage.getItem('usuario'));
    if (!usuario || usuario.rol.toLowerCase() !== 'supervisor') {
      Swal.fire({
        icon: 'warning',
        title: 'Acceso no autorizado',
        text: 'Debes iniciar sesión como supervisor.',
      }).then(() => {
        localStorage.removeItem('usuario');
        window.location.href = 'login.html';
      });
    } else {
      document.getElementById('saludo').textContent = `👋 Bienvenido Supervisor, ${usuario.nombre}`;
      cargarLista();
    }
  }

  verificarSesion();

  // Cerrar sesión
  document.getElementById('btnLogout').addEventListener('click', () => {
    localStorage.removeItem('usuario');
    Swal.fire({
      icon: 'info',
      title: 'Sesión cerrada',
      text: 'Has cerrado sesión correctamente.',
      timer: 1500,
      showConfirmButton: false
    }).then(() => {
      window.location.href = 'login.html';
    });
  });

  // Cargar lista
  async function cargarLista() {
    try {
      const res = await fetch('http://localhost:3000/api/usuarios');
      const data = await res.json();

      const tbody = document.getElementById('tbodyUsuarios');
      tbody.innerHTML = '';

      data.forEach(u => {
        const estadoTexto = u.estado ? 'Activo' : 'Inactivo';
        const fila = `
          <tr>
            <td>${u.nombre}</td>
            <td>${u.gmail}</td>
            <td>${u.rol}</td>
            <td>
              <span class="badge ${u.estado ? 'bg-success' : 'bg-danger'}">${estadoTexto}</span>
            </td>
          </tr>
        `;
        tbody.innerHTML += fila;
      });
    } catch (err) {
      console.error('Error al cargar lista:', err);
      document.getElementById('tbodyUsuarios').innerHTML = `
        <tr><td colspan="4" class="text-center text-danger">Error al cargar los datos.</td></tr>
      `;
    }
  }
</script>
</body>
</html>
