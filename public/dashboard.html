<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel de Usuarios - Dashboard</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Tu CSS personalizado -->
  <link rel="stylesheet" href="styles.css">
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* peque√±o ajuste para centrar t√≠tulo en pantallas peque√±as (opcional) */
    .header-flex { gap: .5rem; flex-wrap: wrap; }
  </style>
</head>
<body class="bg-light">

  <div class="container mt-5">
    <!-- Espacio para el "Bienvenido" (aqu√≠ ir√° cuando hagamos login) -->
    <!-- AQUI IRA EL MENSAJE DE BIENVENIDA (nombre del usuario y rol) -->
    <h2 class="mb-4" id="bienvenida"><!-- Aqu√≠ ir√° el nombre del usuario logueado --></h2>

    <div class="d-flex justify-content-between align-items-center mb-3 header-flex">
      <h3 class="mb-0">üë§ Lista de Usuarios</h3>
      <div>
        <button id="btnNuevo" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalUsuario">
          ‚ûï Nuevo Usuario
        </button>
        <!-- Placeholder para logout m√°s adelante -->
        <!-- <a href="#" class="btn btn-outline-dark">üö™ Cerrar Sesi√≥n</a> -->
      </div>
    </div>

    <div class="card shadow">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-hover text-center align-middle" id="tablaUsuarios">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Correo</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="tbodyUsuarios">
              <tr><td colspan="6">Cargando datos...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal (Agregar / Editar) - Reutilizable -->
  <div class="modal fade" id="modalUsuario" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="formUsuario" novalidate>
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Agregar Usuario</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="usuarioId" value="">

            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input type="text" id="nombre" class="form-control" required>
              <div class="invalid-feedback">El nombre es obligatorio.</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Correo electr√≥nico</label>
              <input type="email" id="gmail" class="form-control" required>
              <div class="invalid-feedback">Ingresa un correo v√°lido.</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Contrase√±a</label>
              <input type="password" id="contrasena" class="form-control" required>
              <div class="form-text">M√≠nimo 8 caracteres, 1 may√∫scula y 1 n√∫mero.</div>
              <div class="invalid-feedback">La contrase√±a debe cumplir el formato.</div>
            </div>

            <div class="mb-3">
              <label class="form-label">Rol</label>
              <select id="selectRol" class="form-select" required>
                <option value="">Cargando roles...</option>
              </select>
              <div class="invalid-feedback">Selecciona un rol v√°lido.</div>
            </div>

            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="estado" checked>
              <label class="form-check-label" for="estado">Activo</label>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" id="btnGuardar" class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Eliminar -->
  <div class="modal fade" id="modalEliminar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger">Eliminar Usuario</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <p>¬øSeguro que deseas eliminar a <strong id="nombreEliminar"></strong>?</p>
          <input type="hidden" id="idEliminar" value="">
        </div>
        <div class="modal-footer">
          <button type="button" id="confirmarEliminar" class="btn btn-danger">Eliminar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // üîí Verificar sesi√≥n (antes de todo)
  const usuarioActual = JSON.parse(localStorage.getItem('usuario'));
  if (!usuarioActual) {
    window.location.href = 'login.html';
  }

  // Mostrar bienvenida
  document.getElementById('bienvenida').textContent = `üëã Bienvenido, ${usuarioActual.nombre} (${usuarioActual.rol})`;

  
  // ------------------ Configuraci√≥n ------------------
  const API_BASE = 'http://localhost:3000'; // URL fija por ahora
  const ENDPOINT_USUARIOS = API_BASE + '/api/usuarios';
  const ENDPOINT_ROLES = API_BASE + '/api/roles';

  // Elementos del DOM
  const tbodyUsuarios = document.getElementById('tbodyUsuarios');
  const selectRol = document.getElementById('selectRol');
  const formUsuario = document.getElementById('formUsuario');
  const modalUsuarioEl = document.getElementById('modalUsuario');
  const bsModalUsuario = new bootstrap.Modal(modalUsuarioEl);
  const modalEliminarEl = document.getElementById('modalEliminar');
  const bsModalEliminar = new bootstrap.Modal(modalEliminarEl);

  // Helpers (validaciones)
  function validarPassword(pw) {
    const regex = /^(?=.*[A-Z])(?=.*\d).{8,}$/;
    return regex.test(pw);
  }

  // ------------------ Cargar Roles ------------------
  async function cargarRoles() {
    try {
      const res = await fetch(ENDPOINT_ROLES);
      if (!res.ok) throw new Error('Error cargando roles');
      const roles = await res.json();
      selectRol.innerHTML = '<option value="">Selecciona...</option>';
      roles.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.id_rol;
        opt.textContent = r.nombre;
        selectRol.appendChild(opt);
      });
    } catch (err) {
      console.error(err);
      selectRol.innerHTML = '<option value="">Error cargando roles</option>';
    }
  }

  // ------------------ Cargar Usuarios (tabla) ------------------
  async function cargarUsuarios() {
    tbodyUsuarios.innerHTML = '<tr><td colspan="6">Cargando datos...</td></tr>';
    try {
      const res = await fetch(ENDPOINT_USUARIOS);
      if (!res.ok) throw new Error('Error al obtener usuarios');
      const usuarios = await res.json();

      if (!Array.isArray(usuarios) || usuarios.length === 0) {
        tbodyUsuarios.innerHTML = '<tr><td colspan="6">No hay usuarios registrados</td></tr>';
        return;
      }

      tbodyUsuarios.innerHTML = '';
      usuarios.forEach(u => {
        const tr = document.createElement('tr');
        tr.className = u.estado ? 'activo' : 'inactivo';

        tr.innerHTML = `
          <td>${u.id}</td>
          <td>${escapeHtml(u.nombre)}</td>
          <td>${escapeHtml(u.gmail)}</td>
          <td>${escapeHtml(u.rol)}</td>
          <td>${u.estado ? '<span class="badge bg-success">Activo</span>' : '<span class="badge bg-danger">Inactivo</span>'}</td>
          <td>
            <button class="btn btn-warning btn-sm me-1 editarBtn">‚úèÔ∏è Editar</button>
            <button class="btn btn-danger btn-sm eliminarBtn">üóëÔ∏è Eliminar</button>
          </td>
        `;

        // Asignar eventos a botones (capturamos datos por closure)
        const editarBtn = tr.querySelector('.editarBtn');
        const eliminarBtn = tr.querySelector('.eliminarBtn');

        editarBtn.addEventListener('click', () => abrirModalEditar(u));
        eliminarBtn.addEventListener('click', () => abrirModalEliminar(u));

        tbodyUsuarios.appendChild(tr);
      });

    } catch (err) {
      console.error(err);
      tbodyUsuarios.innerHTML = '<tr><td colspan="6" class="text-danger">Error al cargar usuarios</td></tr>';
    }
  }

  // Escape simple para evitar inyecci√≥n HTML en los nombres/correos
  function escapeHtml(s) {
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#39;');
  }

  // ------------------ Abrir modal para Agregar ------------------
  document.getElementById('btnNuevo').addEventListener('click', () => {
    document.getElementById('usuarioId').value = '';
    document.getElementById('nombre').value = '';
    document.getElementById('gmail').value = '';
    document.getElementById('contrasena').value = '';
    selectRol.value = '';
    document.getElementById('estado').checked = true;
    document.getElementById('modalTitle').textContent = 'Registrar Nuevo Usuario';
    formUsuario.classList.remove('was-validated');
  });

  // ------------------ Abrir modal para Editar ------------------
  async function abrirModalEditar(u) {
    try {
      // 1. Consultar datos del usuario por su ID
      const response = await fetch(`/api/usuarios/${u.id}`);
      if (!response.ok) throw new Error('Error al obtener usuario por ID');
      const usuario = await response.json();

      // 2. Asignar valores al formulario
      document.getElementById('usuarioId').value = usuario.id;
      document.getElementById('nombre').value = usuario.nombre;
      document.getElementById('gmail').value = usuario.gmail;
      document.getElementById('contrasena').value = usuario.contrasena || '';
      document.getElementById('selectRol').value = usuario.id_rol;
      document.getElementById('estado').checked = !!usuario.estado;

      // 3. Configurar modal y mostrarlo
      document.getElementById('modalTitle').textContent = 'Editar Usuario';
      formUsuario.classList.remove('was-validated');
      bsModalUsuario.show();
    } catch (error) {
      console.error('Error al abrir modal de edici√≥n:', error);
      alert('No se pudo cargar la informaci√≥n del usuario.');
    }
  }


  // ------------------ Abrir modal de eliminar ------------------
  function abrirModalEliminar(u) {
    document.getElementById('idEliminar').value = u.id;
    document.getElementById('nombreEliminar').textContent = u.nombre;
    document.getElementById('idEliminar').value = u.id;
    bsModalEliminar.show();
  }

  // ------------------ Enviar formulario (Agregar / Editar) ------------------
  formUsuario.addEventListener('submit', async (e) => {
    e.preventDefault();
    formUsuario.classList.remove('was-validated');

    const id = document.getElementById('usuarioId').value;
    const nombre = document.getElementById('nombre').value.trim();
    const gmail = document.getElementById('gmail').value.trim();
    const contrasena = document.getElementById('contrasena').value.trim();
    const id_rol = parseInt(selectRol.value);
    const estado = document.getElementById('estado').checked;

    // Validaciones
    if (!nombre || !gmail || !contrasena || !id_rol) {
      formUsuario.classList.add('was-validated');
      return;
    }
    if (!validarPassword(contrasena)) {
      Swal.fire({ icon: 'warning', title: 'Contrase√±a inv√°lida', text: 'La contrase√±a debe tener 8+ caracteres, una may√∫scula y un n√∫mero.' });
      return;
    }

    try {
      let res, data;
      if (!id) {
        // POST -> crear
        res = await fetch(ENDPOINT_USUARIOS, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre, gmail, contrasena, id_rol, estado })
        });
      } else {
        // PUT -> editar
        res = await fetch(`${ENDPOINT_USUARIOS}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre, gmail, contrasena, id_rol, estado })
        });
      }

      data = await res.json();

      if (!res.ok) {
        throw new Error(data.mensaje || JSON.stringify(data));
      }

      // √âxito
      Swal.fire({
        icon: 'success',
        title: data.mensaje || (id ? 'Usuario actualizado' : 'Usuario creado'),
        timer: 1400,
        showConfirmButton: false
      });

      bsModalUsuario.hide();
      formUsuario.reset();
      await cargarUsuarios();

    } catch (err) {
      console.error(err);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: err.message || 'Error al procesar la solicitud'
      });
    }
  });

  // ------------------ Confirmar y ejecutar eliminaci√≥n ------------------
  document.getElementById('confirmarEliminar').addEventListener('click', async () => {
    const id = document.getElementById('idEliminar').value;
    if (!id) return;

    try {
      const res = await fetch(`${ENDPOINT_USUARIOS}/${id}`, { method: 'DELETE' });
      const data = await res.json();
      if (!res.ok) throw new Error(data.mensaje || 'Error al eliminar');

      Swal.fire({ icon: 'success', title: data.mensaje || 'Usuario eliminado', timer: 1200, showConfirmButton: false });
      bsModalEliminar.hide();
      await cargarUsuarios();
    } catch (err) {
      console.error(err);
      Swal.fire({ icon: 'error', title: 'Error', text: err.message || 'No se pudo eliminar' });
    }
  });

  // ------------------ Inicializaci√≥n ------------------
  (async function init() {
    // Cargar roles y usuarios
    await cargarRoles();
    await cargarUsuarios();

    // En este lugar puedes inyectar el nombre del usuario / rol cuando implementes login
    // ejemplo:
    // document.getElementById('bienvenida').textContent = `üëã Bienvenido, ${nombreUsuario} - ${nombreRol}`;
    // <-- AQU√ç IR√Å EL MENSAJE DE BIENVENIDA (LOGIN) -->
  })();

  </script>
</body>
</html>